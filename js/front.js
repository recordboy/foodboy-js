/*
 * @object name: 추후 객체 지정 예정
 * @info: 점심시간 식당 랜덤 선택 스크립트
 * @date: 2020-03-29
 * @author: 기록맨
 */

var input = null,
    btnAdd = null,
    btnAllDel = null,
    btnDel = null,
    btnMix = null,
    btnSelect = null,
    listFood = null,
    selectSet = null,
    selectNum = 0,
    randomNum = 0,
    resuleNum = 0,
    moveNumNext = 0,
    moveNumPrev = 0,
    foodList = [];

input = document.getElementById('input-txt');
btnAdd = document.getElementById('btn-add');
btnAllDel = document.getElementById('btn-all-del');
btnMix = document.getElementById('btn-mix');
btnSelect = document.getElementById('btn-select');
listFood = document.getElementById('list-food');
selectFood = document.getElementById('select-food');

btnAdd.addEventListener('click', function () {
    var val = input.value;
    if (val === '') {
        alert('값을 입력해주세요.');
        return;
    }
    for (var i = 0; i < localStorage.length; i++) {
        if (localStorage.getItem(val)) {
            alert('중복된 값입니다.');
            return;
        }
    }
    localStorage.setItem(val, val);
    addList(val);
    input.value = '';
});

btnAllDel.addEventListener('click', function (e) {
    localStorage.clear();
    delAllList();
});

listFood.addEventListener('click', function (e) {
    var idx = 0,
        target = null;
    if (e.target.classList[0] === 'btnDel') {
        for (var i = 0; i < listFood.children.length; i++) {
            if (listFood.children[i] == e.path[1]) {
                target = listFood.children[idx];
                listFood.removeChild(target);
                localStorage.removeItem(e.target.previousSibling.data);
            }
            idx++;
        }
    }
});

btnMix.addEventListener('click', function (e) {
    if (listFood.children.length <= 0) {
        alert('항목이 없습니다.');
        return;
    } else if (listFood.children.length < 2) {
        alert('항목을 2개 이상 입력하세요.');
        return;
    }
    listMix(listFood.children.length);
});

btnSelect.addEventListener('click', function (e) {
    moveInit();
    randomSelect();
});

selectFood.getElementsByClassName('yes')[0].addEventListener('click', function (e) {
  selectFood.style.display = 'none';
  setFoodData(true, selectFood.getElementsByClassName('target')[0].textContent);
});

selectFood.getElementsByClassName('no')[0].addEventListener('click', function (e) {
  selectFood.style.display = 'none';
});

function addList(val) {
    var li = document.createElement('li');
    li.innerHTML = val + '<button type="button" class="btnDel">delete</button>';
    listFood.appendChild(li);
    btnDel = document.getElementsByClassName('btnDel');
}

function delAllList() {
    var len = listFood.children.length;
    for (var i = 0; i < len; i++) {
        listFood.removeChild(listFood.children[0]);
    }
}

function listMix(len) {
    var arr = [],
        newArr = [],
        ranIdx = 0,
        ran = 0,
        target = 0;
    listFood.children[moveNumPrev].classList.remove('on');
    for (var i = 0; i < len; i++) {
        arr.push(i);
    }
    console.log(arr)
    for (var j = 0; j < len; j++) {
        ranIdx = Math.floor((Math.random() * arr.length));
        ran = arr[ranIdx];
        if (arr.indexOf(ran) !== -1) {
            target = arr.indexOf(ran);
            arr.splice(target, 1);
            newArr.push(ran);
        }
        listFood.appendChild(listFood.children[newArr[j]]);
    }
    console.log(newArr);
}


function getStorage() {
    for (var i = 0; i < localStorage.length; i++) {
        addList(localStorage.key(i));
    }
}

function randomSelect() {
    if (localStorage.length <= 1) {
        alert('항목을 2개 이상 입력하세요.')
        return;
    }
    randomNum = Math.floor(Math.random() * localStorage.length) + 1;
    selectNum = randomNum;
    resuleNum = (randomNum + 30) % localStorage.length;
    selectPoint();
    setDisabled(true);
    console.log('result index : ' + resuleNum);
}

function selectPoint() {
    var reslutLen = listFood.children[resuleNum].textContent.length,
        result = listFood.children[resuleNum].textContent.substr(0, reslutLen - 6);
    if (selectNum === randomNum) {
        selectStart(10 + randomNum, 30);
    } else if (selectNum === 10 + randomNum) {
        selectStart(15 + randomNum, 60);
    } else if (selectNum === 15 + randomNum) {
        selectStart(20 + randomNum, 120);
    } else if (selectNum === 20 + randomNum) {
        selectStart(25 + randomNum, 240);
    } else if (selectNum === 25 + randomNum) {
        selectStart(30 + randomNum, 400);
    } else if (selectNum === 30 + randomNum) {
        setTimeout(function () {
            setDisabled(false);
            selectFood.style.display = 'block';
            selectFood.getElementsByClassName('target')[0].innerHTML = result;
        }, 400);
    }
}

function selectStart(point, spped) {
    selectSet = setInterval(function () {
        selectNum++;
        if (selectNum === point) {
            clearInterval(selectSet);
            selectPoint();
        }
        selectMove();
    }, spped)
}

function selectMove() {
    moveNumNext = selectNum % localStorage.length;
    if (moveNumNext === 0) {
        prev = localStorage.length - 1;
    }
    listFood.children[moveNumNext].classList.add('on')
    listFood.children[moveNumPrev].classList.remove('on')
    moveNumPrev = moveNumNext;
}

function moveInit() {
    moveNumNext = 0;
    moveNumPrev = 0;
}

function setDisabled(bool) {
    var len = listFood.children.length;
    btnAdd.disabled = bool;
    btnAllDel.disabled = bool;
    btnMix.disabled = bool;
    btnSelect.disabled = bool;
    for (var i = 0; i < len; i++) {
        listFood.children[i].children[0].disabled = bool;
    }
}

function setFoodData(res, food) {
  if (res) {
    foodList.push(food);
    createFoodList(foodList);
  }
}

function createFoodList(foodList) {
  // let today = new Date();   
  
  // let year = today.getFullYear(); // 년도
  // let month = today.getMonth() + 1;  // 월
  // let date = today.getDate();  // 날짜
  // let day = today.getDay();  // 요일
  
  // document.write(year + '/' + month + '/' + date)
  // document.write('<br>')
  // document.write(day);
  
  // console.log(foodList);
}


getStorage();
